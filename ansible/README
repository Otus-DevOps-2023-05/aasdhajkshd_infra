ДЗ: Ansible-1
JSON не поддерживает комментарии, как yml
Статический инвентарь - это статичный файл, в котором явно были указаны хосты, группы хостов и их свойства. Это формат INI или YAML, включающий в себя информацию о хостах, их IP-адресах, переменных и т.д. Как пример, он был в самом начале.
Динамический инвентарь - это механизм, позволяющий Ansible получать информацию о хостах и группах хостов в режиме реального времени. Вместо хранения информации в статических файлах, можно написать собственный скрипт или использовать готовые инструменты, которые по запросу Ansible предоставляют актуальные данные о вашей инфраструктуре. Результатом работы динамического инвентаря также может быть файл в формате JSON, который включает в себя информацию о хостах и группах.

Пример JSON для динамического в файле inventory.json

ДЗ: Ansible-2
Вынес информацию о внутреннем адресе в output-переменную в Terraform:
> cat ../modules/db/outputs.tf
output "ip_addresses_db" {
  value = [
    for instance in yandex_compute_instance.reddit-db :
    {
      external_ip = instance.network_interface[0].nat_ip_address
      internal_ip = instance.network_interface[0].ip_address
    }
  ]
}
вывод после terraform apply
ip_addresses_db = [
  {
    "external_ip" = "158.160.54.176"
    "internal_ip" = "10.128.0.34"
  },
]
См. лог terraform.log

Самостоятельно, по аналогии с предыдущими заданиями добавил сценарий для разворачивания приложения в плейбук reddit_app2.yml
Добавил reddit_app3.yml, где task'и с tag'ом deploy-tag добавил в общий раздел и проверил, что deploy задачи так же запускаются, даже при наличии индивидуального другого tag'а deploy-tag, который глобальный ansible-playbook reddit_app3.yml -vv --tags app-tag, а вот если указывать deploy-tag - выполняются задачи с указанной меткой

Проверил работу запуска handler'а с указанием notify.

Убедился, что приложение доступно по внешнему IP инстанса приложения и подключение выполняется к ДБ другого узла.

Задание со *:
keyed_groups - это плагин для группировки хостов в Ansible и позволяет создавать дополнительные группы хостов на основе значений переменных (ключей), определенных для каждого хоста. Например, keyed_groups позволяет создать дополнительные группы, используя значения переменных, определенных для хостов.Как пример environment, содержащей значения dev, staging и prod и использовать эти группы keyed_groups для создания групп по каждому окружению:
plugin: keyed_groups
key: environment

Понадобилось задать пользователя "user" в ""provisioners", чтобы подключаться ansible от пользователя, чтобы стать become:
https://www.reddit.com/r/ansible/comments/z7126j/provisioning_packer_image_with_ansbile/

Для решения проблемы
"yandex: fatal: [default]: UNREACHABLE! => {"changed": false, "msg": "Failed to connect to the host via ssh: Unable to negotiate with 127.0.0.1 port 38299: no matching host key type found. Their offer: ssh-rsa", "unreachable": true}"
добавил записи в ~/.ssh/config
Host 127.0.0.1
    HostKeyAlgorithms +ssh-rsa
    PubkeyAcceptedAlgorithms +ssh-rsa

Далее проблема с передачей файлов
yandex: fatal: [default]: FAILED! => {"msg": "failed to transfer file to ... AnsiballZ_setup.py:\n\n"}
https://developer.hashicorp.com/packer/plugins/provisioners/ansible/ansible#ssh_authorized_key_file
получилось победить, указав в provisioners -> "ansible_env_vars": ["ANSIBLE_CONFIG=ansible/ansible.cfg", "ANSIBLE_PIPELINING=true"]
После успешной сборки app образа packer'ом, был собран db

В packer_db.yml для установки выполнял установку версии 4.4 с импортом ключа с https://www.mongodb.org/static/pgp/server-4.4.asc
После стало дело подготовки файлов по имеющейся схеме...
[elnone@thinky] 15:52 $ yc compute images list
+----------------------+------------------------+-------------+----------------------+--------+
|          ID          |          NAME          |   FAMILY    |     PRODUCT IDS      | STATUS |
+----------------------+------------------------+-------------+----------------------+--------+
| fd82kuluc04013sbe22g | reddit-app-1692362168  | reddit-base | f2e5pn9cvd0mf5sg7bdn | READY  |
| fd8idgg4s709v05bagtm | reddit-base-1688384452 | reddit-base | f2eatq1k1am8rbdi37ap | READY  |
| fd8ndf64j3jukuq3pdct | reddit-db-1692362938   | reddit-base | f2e5pn9cvd0mf5sg7bdn | READY  |
+----------------------+------------------------+-------------+----------------------+--------+

+ Выполнен билд образов с использованием нового провижинера.
+ На основе созданных app и db образов запустил stage окружение в Yandex. Новые адреса внесены в inventory* файлы.
+ Проверено, что c помощью плейбука site.yml из предыдущего раздела окружение конфигурируется, а приложение деплоится и работает.
См. ansible.log
